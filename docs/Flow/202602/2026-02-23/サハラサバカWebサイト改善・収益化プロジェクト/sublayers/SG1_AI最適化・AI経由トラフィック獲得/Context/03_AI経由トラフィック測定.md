# AI経由トラフィック測定

## 測定の重要性

### なぜ測定が必要か
- **効果検証**: AI最適化施策の成果を定量的に把握
- **改善サイクル**: データに基づいたPDCA
- **ROI算出**: 投資対効果の明確化
- **戦略調整**: どのAIプラットフォームが効果的か判断

### 測定すべき指標
1. **AI経由トラフィック数**
2. **AIプラットフォーム別内訳**
3. **AI経由CVR**（コンバージョン率）
4. **AI経由ページ滞在時間**
5. **AI経由直帰率**

---

## GA4カスタムイベント設計

### 1. AI Referer検出ロジック

**対象AIプラットフォーム**

```typescript
// src/utils/aiDetection.ts

export const AI_PLATFORMS = {
  CHATGPT: {
    name: 'ChatGPT',
    referers: ['chatgpt.com', 'chat.openai.com'],
    userAgents: ['ChatGPT', 'GPTBot']
  },
  CLAUDE: {
    name: 'Claude',
    referers: ['claude.ai', 'anthropic.com'],
    userAgents: ['Claude']
  },
  PERPLEXITY: {
    name: 'Perplexity',
    referers: ['perplexity.ai'],
    userAgents: ['PerplexityBot']
  },
  GEMINI: {
    name: 'Gemini',
    referers: ['gemini.google.com', 'bard.google.com'],
    userAgents: ['Google-Extended']
  },
  BING_CHAT: {
    name: 'Bing Chat',
    referers: ['bing.com/chat', 'edgeservices.bing.com'],
    userAgents: ['BingPreview']
  },
  YOU_COM: {
    name: 'You.com',
    referers: ['you.com'],
    userAgents: ['YouBot']
  }
} as const;

export function detectAIPlatform(
  referer: string,
  userAgent: string
): string | null {
  for (const [key, platform] of Object.entries(AI_PLATFORMS)) {
    // Refererチェック
    if (platform.referers.some(ref => referer.includes(ref))) {
      return platform.name;
    }

    // User-Agentチェック
    if (platform.userAgents.some(ua => userAgent.includes(ua))) {
      return platform.name;
    }
  }

  return null;
}

export function isAITraffic(
  referer: string,
  userAgent: string
): boolean {
  return detectAIPlatform(referer, userAgent) !== null;
}
```

---

### 2. GA4イベント送信

**カスタムイベント実装**

```typescript
// src/utils/analytics.ts

import { detectAIPlatform, isAITraffic } from './aiDetection';

// AI経由訪問の記録
export function trackAIVisit() {
  const referer = document.referrer;
  const userAgent = navigator.userAgent;

  if (!isAITraffic(referer, userAgent)) {
    return;
  }

  const platform = detectAIPlatform(referer, userAgent);

  // セッションストレージに保存（後でCV測定に使用）
  sessionStorage.setItem('ai_platform', platform || 'unknown');
  sessionStorage.setItem('ai_entry_time', Date.now().toString());

  // GA4イベント送信
  if (window.gtag) {
    window.gtag('event', 'ai_visit', {
      ai_platform: platform,
      page_path: window.location.pathname,
      page_title: document.title,
      referer: referer,
      user_agent: userAgent
    });
  }
}

// AI経由コンバージョンの記録
export function trackAIConversion(
  conversionType: 'affiliate_click' | 'form_submit' | 'sponsor_inquiry'
) {
  const aiPlatform = sessionStorage.getItem('ai_platform');

  if (!aiPlatform) {
    return; // AI経由ではない
  }

  const entryTime = sessionStorage.getItem('ai_entry_time');
  const timeToConversion = entryTime
    ? Date.now() - parseInt(entryTime)
    : null;

  if (window.gtag) {
    window.gtag('event', 'ai_conversion', {
      ai_platform: aiPlatform,
      conversion_type: conversionType,
      time_to_conversion_ms: timeToConversion,
      page_path: window.location.pathname
    });
  }
}

// アフィリエイトリンククリック追跡
export function trackAffiliateClick(
  productName: string,
  affiliateType: 'amazon' | 'rakuten'
) {
  trackAIConversion('affiliate_click');

  if (window.gtag) {
    window.gtag('event', 'affiliate_click', {
      product_name: productName,
      affiliate_type: affiliateType,
      ai_platform: sessionStorage.getItem('ai_platform')
    });
  }
}
```

---

### 3. React統合

**App.tsxでの初期化**

```typescript
// src/App.tsx

import { useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import { trackAIVisit, pageview } from './utils/analytics';

function App() {
  const location = useLocation();

  useEffect(() => {
    // ページ読み込み時にAI経由チェック
    trackAIVisit();

    // 通常のページビュー送信
    pageview(location.pathname);
  }, []);

  useEffect(() => {
    // ルート変更時のページビュー
    pageview(location.pathname);
  }, [location]);

  return (
    // ...
  );
}
```

**アフィリエイトリンクでの使用**

```typescript
// src/components/AffiliateLink.tsx

import { trackAffiliateClick } from '../utils/analytics';

interface AffiliateLinkProps {
  href: string;
  productName: string;
  type: 'amazon' | 'rakuten';
  children: React.ReactNode;
}

export const AffiliateLink: React.FC<AffiliateLinkProps> = ({
  href,
  productName,
  type,
  children
}) => {
  const handleClick = () => {
    trackAffiliateClick(productName, type);
  };

  return (
    <a
      href={href}
      target="_blank"
      rel="noopener noreferrer nofollow"
      onClick={handleClick}
    >
      {children}
    </a>
  );
};
```

---

## GA4ダッシュボード設計

### 1. カスタムレポート設定

**「AI経由トラフィック」レポート**

| 指標 | 説明 |
|------|------|
| AI訪問数 | イベント`ai_visit`の合計 |
| AIプラットフォーム | ディメンション`ai_platform` |
| AI経由CV数 | イベント`ai_conversion`の合計 |
| AI経由CVR | CV数 ÷ 訪問数 |

**設定手順**
1. GA4 > 探索 > 「空白」を選択
2. ディメンション追加:
   - `イベント名`
   - `イベントパラメータ: ai_platform`
   - `ページパス`
3. 指標追加:
   - `イベント数`
   - `セッション数`
   - `エンゲージメント率`
4. フィルタ追加:
   - イベント名 = `ai_visit` OR `ai_conversion`

---

### 2. 主要KPI設定

**目標値**

| KPI | 目標値 | 測定方法 |
|-----|--------|----------|
| AI経由トラフィック比率 | 20-30% | AI訪問数 ÷ 全訪問数 |
| AI経由CVR | 全体CVRの1.5倍 | AI経由CV数 ÷ AI訪問数 |
| AIプラットフォームトップ3 | ChatGPT, Claude, Perplexity | ai_platform別集計 |

**週次レポート内容**
- AI経由訪問数の推移
- AIプラットフォーム別内訳
- AI経由人気ページTop10
- AI経由CV数・CVR

---

## 実装チェックリスト

### フェーズ1: 基本測定（1-2日）
- [ ] `aiDetection.ts`実装
- [ ] `analytics.ts`にAI追跡機能追加
- [ ] `App.tsx`に初期化コード追加
- [ ] GA4でカスタムイベント確認

### フェーズ2: CV測定（1-2日）
- [ ] `trackAIConversion`実装
- [ ] アフィリエイトリンクに追跡追加
- [ ] お問い合わせフォームに追跡追加
- [ ] GA4でCV確認

### フェーズ3: ダッシュボード（1日）
- [ ] GA4カスタムレポート作成
- [ ] 週次レポート自動化
- [ ] アラート設定（トラフィック急増時）

---

## トラブルシューティング

### イベントが記録されない

**原因1**: Refererが空
- **解決**: User-Agent検出も併用

**原因2**: sessionStorageが無効
- **解決**: Cookieへの代替保存

**原因3**: GA4遅延
- **解決**: 24-48時間待ってから確認

### CVが正しく測定されない

**原因**: セッション切れ
- **解決**: `ai_platform`をlocalStorageに保存（7日間保持）

---

## プライバシー対応

### GDPR・CCPA対応
- User-Agent情報は最小限のみ使用
- 個人を特定する情報は収集しない
- Cookie同意バナーでAI追跡も説明

### オプトアウト
```typescript
// ユーザーがトラッキング拒否した場合
if (!hasUserConsent()) {
  return; // AI追跡をスキップ
}
```
